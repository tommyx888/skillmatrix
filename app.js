const translations = {
    en: {
        // Navigation
        "Dashboard": "Dashboard",
        "Candidates": "Candidates",
        "Recruiting Requests": "Recruiting Requests",
        "GM Approval": "GM Approval",
        "Logout": "Logout",
        "Welcome to the Recruiting Management Dashboard!": "Welcome to the Recruiting Management Dashboard!",
        "Add New Candidate": "Add New Candidate",
        "Create Recruiting Request": "Create Recruiting Request",
        "Candidates": "Candidates",
        "All Departments": "All Departments",
        "All Positions": "All Positions",
        "All Sources": "All Sources",
        "Add New Candidate": "Add New Candidate",
        "Full Name": "Full Name",
        "Department": "Department",
        "Position": "Position",
        "Source": "Source",
        "Date Obtained": "Date Obtained",
        "Upload CV": "Upload CV",
        "Upload Assessment Form": "Upload Assessment Form",
        "Interviewer": "Interviewer",
        "Status": "Status",
        "Notes": "Notes",
        "Create New Recruiting Request": "Create New Recruiting Request",
        "Job Description": "Job Description",
        "Headcount": "Headcount",
        "Position Type": "Position Type",
        "New Position": "New Position",
        "Replacement": "Replacement",
        "Reason for New Position": "Reason for New Position",
        "Name of Person Being Replaced": "Name of Person Being Replaced",
        "Position Category": "Position Category",
        "SAL": "SAL",
        "IND": "IND",
        "Confidential Request": "Confidential Request",
        "Submit Request": "Submit Request",
        "Please fill in all required fields": "Please fill in all required fields",
        "Request created successfully!": "Request created successfully!",
        "New": "New",
        "In Process - First Round": "In Process - First Round",
        "In Process - Second Round": "In Process - Second Round",
        "Hired - Contact Source": "Hired - Contact Source",
        "Rejected - Inform Source": "Rejected - Inform Source",
        "Hired": "Hired",
        "Rejected": "Rejected",


        // Dashboard
        "Welcome to the Recruiting Management Dashboard!": "Welcome to the Recruiting Management Dashboard!",
        "Add New Candidate": "Add New Candidate",
        "Create Recruiting Request": "Create Recruiting Request",

        // Candidates
        "New": "New",
        "In Process - First Round": "In Process - First Round",
        "In Process - Second Round": "In Process - Second Round",
        "Hired - Contact Source": "Hired - Contact Source",
        "Rejected - Inform Source": "Rejected - Inform Source",
        "Hired": "Hired",
        "Rejected": "Rejected",
        "Name": "Name",
        "Department": "Department",
        "Position": "Position",
        "Source": "Source",
        "Date Obtained": "Date Obtained",
        "Interviewer": "Interviewer",
        "Status": "Status",
        "CV": "CV",
        "Notes": "Notes",
        "Actions": "Actions",
        "Admin Actions": "Admin Actions",
        "View Details": "View Details",
        "Edit": "Edit",
        "Delete": "Delete",
        "Invite": "Invite",
        "Second Round": "Second Round",
        "Hire": "Hire",
        "Reject": "Reject",
        "Source Informed": "Source Informed",
        "Download CV": "Download CV",
        "Download Assessment": "Download Assessment",
        "No CV": "No CV",
        "No notes": "No notes", "New": "Nový",
        "In Process - First Round": "V procese - Prvé kolo",
        "In Process - Second Round": "V procese - Druhé kolo",
        "Hired - Source Informed": "Hired - Source Informed",
        "Rejected - Source Informed": "Rejected - Source Informed",
        "Hired": "Prijatý",
        "Rejected": "Zamietnutý",

        // Add/Edit Candidate
        "Full Name": "Full Name",
        "Select a department": "Select a department",
        "Select a position": "Select a position",
        "Select a source": "Select a source",
        "Upload CV": "Upload CV",
        "Upload Assessment Form": "Upload Assessment Form",
        "Add Candidate": "Add Candidate",
        "Update Candidate": "Update Candidate",
        "Update Password": "Update Password",

        // Recruiting Requests
        "New Requests": "New Requests",
        "Pending Requests": "Pending Requests",
        "Approved Requests": "Approved Requests",
        "Rejected Requests": "Rejected Requests",
        "Filled Requests": "Filled Requests",
        "Create New Request": "Create New Request",
        "Headcount": "Headcount",
        "Type": "Type",
        "Category": "Category",
        "Confidential": "Confidential",
        "Approve": "Approve",
        "Position Filled": "Position Filled",

        // Create Request
        "Job Description": "Job Description",
        "Position Type": "Position Type",
        "New Position": "New Position",
        "Replacement": "Replacement",
        "Reason for New Position": "Reason for New Position",
        "Name of Person Being Replaced": "Name of Person Being Replaced",
        "Position Category": "Position Category",
        "SAL": "SAL",
        "IND": "IND",
        "Confidential Request": "Confidential Request",
        "Submit Request": "Submit Request",
        "Recruiting Management System": "Recruiting Management System",

        // Misc
        "Yes": "Yes",
        "No": "No",
        "Error": "Error",
        "Success": "Success",
        "Cancel": "Cancel",
        "Save": "Save",
        "Back": "Back"
    },
    sk: {
        // Navigation
        "Dashboard": "Nástenka",
        "Candidates": "Kandidáti",
        "Recruiting Requests": "Žiadosti o nábor",
        "GM Approval": "Schválenie GM",
        "Logout": "Odhlásiť sa",
        "Add New Candidate": "Pridať nového kandidáta",
        "Full Name": "Celé meno",
        "Department": "Oddelenie",
        "Position": "Pozícia",
        "Source": "Zdroj",
        "Date Obtained": "Dátum získania",
        "Upload CV": "Nahrať životopis",
        "Upload Assessment Form": "Nahrať hodnotiaci formulár",
        "Interviewer": "Pohovorujúci",
        "Status": "Stav",
        "Notes": "Poznámky",
        "Create New Recruiting Request": "Vytvoriť novú žiadosť o nábor",
        "Job Description": "Popis práce",
        "Headcount": "Počet pracovníkov",
        "Position Type": "Typ pozície",
        "New Position": "Nová pozícia",
        "Replacement": "Náhrada",
        "Reason for New Position": "Dôvod novej pozície",
        "Name of Person Being Replaced": "Meno nahradzovanej osoby",
        "Position Category": "Kategória pozície",
        "SAL": "SAL",
        "IND": "IND",
        "Confidential Request": "Dôverná žiadosť",
        "Submit Request": "Odoslať žiadosť",
        "Please fill in all required fields": "Prosím, vyplňte všetky povinné polia",
        "Request created successfully!": "Žiadosť bola úspešne vytvorená!",
        "Error creating request: ": "Chyba pri vytváraní žiadosti: ",
        "Select a department": "Vyberte oddelenie",
        "Select a department first": "Najprv vyberte oddelenie",
        "Select a source": "Vyberte zdroj",
        "New": "Nový",
        "In Process - First Round": "V procese - Prvé kolo",
        "In Process - Second Round": "V procese - Druhé kolo",
        "Hired": "Prijatý",
        "Rejected": "Zamietnutý",
        "Candidate added successfully!": "Kandidát bol úspešne pridaný!",
        "Error adding candidate: ": "Chyba pri pridávaní kandidáta: ",
        "Select Position": "Vyberte pozíciu",
        "Supabase client not initialized": "Supabase klient nie je inicializovaný",
        "Error: Supabase client not initialized": "Chyba: Supabase klient nie je inicializovaný",
        "No data returned from insert operation": "Z operácie vloženia neboli vrátené žiadne dáta",
        "Request created successfully:": "Žiadosť bola úspešne vytvorená:",
        "Error sending email to GMs:": "Chyba pri odosielaní e-mailu generálnym manažérom:",
        "Email sent successfully to GMs:": "E-mail bol úspešne odoslaný generálnym manažérom:",
        "Error invoking send-gm-email function:": "Chyba pri volaní funkcie send-gm-email:",
        "Candidates": "Kandidáti",
        "All Departments": "Všetky oddelenia",
        "All Positions": "Všetky pozície",
        "All Sources": "Všetky zdroje",
        "Apply Filters": "Použiť filtre",
        "Candidates in Process": "Kandidáti v procese",
        "Hired Candidates": "Prijatí kandidáti",
        "Rejected Candidates": "Zamietnutí kandidáti",
        "Name": "Meno",
        "Documents": "Dokumenty",
        "Actions": "Akcie",
        "Admin Actions": "Administratívne akcie",
        "View Details": "Zobraziť detaily",
        "Invite": "Pozvať",
        "Reject": "Zamietnuť",
        "Second Round": "Druhé kolo",
        "Hire": "Prijať",
        "Download CV": "Stiahnuť životopis",
        "Download Assessment": "Stiahnuť hodnotenie",
        "No documents": "Žiadne dokumenty",
        "No notes": "Žiadne poznámky",
        "Recruiting Requests": "Žiadosti o nábor",
        "Create New Request": "Vytvoriť novú žiadosť",
        "Welcome to the Recruiting Management Dashboard!": "Vitajte v paneli riadenia náboru!",
        "Dashboard": "Nástenka",
        "GM Approval": "Schválenie GM",
        "Logout": "Odhlásiť sa",
        "Update Password": "Aktualizovať heslo",
        "Current Password": "Aktuálne heslo",
        "New Password": "Nové heslo",
        "Confirm New Password": "Potvrďte nové heslo",
        "New passwords do not match": "Nové heslá sa nezhodujú",
        "Password updated successfully": "Heslo bolo úspešne aktualizované",
        "Error updating password. Please try again.": "Chyba pri aktualizácii hesla. Prosím, skúste to znova.",

        // Dashboard
        "Welcome to the Recruiting Management Dashboard!": "Vitajte v paneli riadenia náboru!",
        "Add New Candidate": "Pridať nového kandidáta",
        "Create Recruiting Request": "Vytvoriť žiadosť o nábor",

        // Candidates
        "New": "Nový",
        "In Process - First Round": "V procese - Prvé kolo",
        "In Process - Second Round": "V procese - Druhé kolo",
        "Hired - Source Informed": "Prijatý - Kontaktovať zdroj",
        "Rejected - Source Informed": "Zamietnutý - Informovať zdroj",
        "Hired": "Prijatý",

        "Rejected": "Zamietnutý",
        "Name": "Meno",
        "Department": "Oddelenie",
        "Position": "Pozícia",
        "Source": "Zdroj",
        "Date Obtained": "Dátum získania",
        "Interviewer": "Pohovorujúci",
        "Status": "Stav",
        "CV": "Životopis",
        "Notes": "Poznámky",
        "Actions": "Akcie",
        "Admin Actions": "Administratívne akcie",
        "View Details": "Zobraziť detaily",
        "Edit": "Upraviť",
        "Delete": "Vymazať",
        "Invite": "Pozvať",
        "Second Round": "Druhé kolo",
        "Hire": "Prijať",
        "Reject": "Zamietnuť",
        "Source Informed": "Zdroj informovaný",
        "Download CV": "Stiahnuť životopis",
        "Download Assessment": "Stiahnuť hodnotenie",
        "No CV": "Bez životopisu",
        "No notes": "Žiadne poznámky",

        // Add/Edit Candidate
        "Full Name": "Celé meno",
        "Select a department": "Vyberte oddelenie",
        "Select a position": "Vyberte pozíciu",
        "Select a source": "Vyberte zdroj",
        "Upload CV": "Nahrať životopis",
        "Upload Assessment Form": "Nahrať formulár hodnotenia",
        "Add Candidate": "Pridať kandidáta",
        "Update Candidate": "Aktualizovať kandidáta",
        "Update Password": "Aktualizovať Heslo",

        // Recruiting Requests
        "New Requests": "Nové žiadosti",
        "Pending Requests": "Čakajúce žiadosti",
        "Approved Requests": "Schválené žiadosti",
        "Rejected Requests": "Zamietnuté žiadosti",
        "Filled Requests": "Obsadené pozície",
        "Create New Request": "Vytvoriť novú žiadosť",
        "Headcount": "Počet pracovníkov",
        "Type": "Typ",
        "Category": "Kategória",
        "Confidential": "Dôverné",
        "Approve": "Schváliť",
        "Position Filled": "Pozícia obsadená",

        // Create Request
        "Job Description": "Popis práce",
        "Position Type": "Typ pozície",
        "New Position": "Nová pozícia",
        "Replacement": "Náhrada",
        "Reason for New Position": "Dôvod novej pozície",
        "Name of Person Being Replaced": "Meno nahradzovanej osoby",
        "Position Category": "Kategória pozície",
        "SAL": "SAL",
        "IND": "IND",
        "Confidential Request": "Dôverná žiadosť",
        "Submit Request": "Odoslať žiadosť",
        "Recruiting Management System": "Systém riadenia náboru",

        // Misc
        "Yes": "Áno",
        "No": "Nie",
        "Error": "Chyba",
        "Success": "Úspech",
        "Cancel": "Zrušiť",
        "Save": "Uložiť",
        "Back": "Späť"
    }
};



// Supabase client
let supabaseInstance;
let currentLanguage = 'sk'; // Default language


// Initialize Supabase client
function initSupabase() {
    const supabaseUrl = 'https://jlpkwktqylbykvpafmmc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpscGt3a3RxeWxieWt2cGFmbW1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY1OTIxMjYsImV4cCI6MjA0MjE2ODEyNn0.c-UPO_SNxUGtqLEY4YNpciDLJqtO6j4OSKxS-8y9cFI';

    if (!supabaseInstance) {
        try {
            supabaseInstance = supabase.createClient(supabaseUrl, supabaseKey);
            console.log('Supabase client initialized successfully');
        } catch (error) {
            console.error('Error initializing Supabase client:', error);
            alert('Error initializing Supabase client. Please check the console for more details.');
        }
    }
    return supabaseInstance;
}


// Get Supabase instance (initialize if not already done)
function getSupabase() {
    if (!supabaseInstance) {
        console.error('Supabase client not initialized');
        return null;
    }
    return supabaseInstance;
}


// Department-Position mapping
const departmentPositions = {

    'Business': ['Assistant Buyer', 'Buyer', 'Supplier Quality Assurance Engineer', 'Business Administration', 'Business Sales & Cost Analyst'],
    'CI': ['CI Coordinator', 'CI Analyst', 'CI Technician'],
    'Engineering': ['Senior Process Engineer 1', 'Senior Process Engineer IM', 'Process Engineer 1', 'Senior IM Technologist Coordinator', 'Process Engineer IM', 'Senior Technologist IM', 'Foreman Technologist IM', 'Technologist IM', 'Mold Changer', 'Materialist', 'Senior Process Engineer 2', 'Process Engineer 2', 'Senior Technologist Coordinator', 'Tooling Engineer', 'Product Engineer', 'Change BOM Coordinator', 'Programe Engineer', 'Technologist 1', 'Quality Program Engineer', 'Launch Coordinator', 'Data Analyst', 'Manufacturing Engineer'],
    'Finance': ['Programme Controller', 'Finance Analyst', 'Chief Accountant', 'Financial Specialist Senior', 'Supplier Accountant', 'Services Accountant', 'Financial Assistant', 'Financial Clerk', 'Revenue Accountant', 'Financial Specialist', 'Treasury Analyst', 'Senior Treasury & Financial Analyst'],
    'HR': ['Payroll accountant', 'Senior HR Generalist', 'Recruiter', 'HR Generalist 1', 'Junior Payroll', 'Training Center Trainer', 'HSE Specialist', 'Environment Officer', 'Executive assistant'],
    'IT': ['IT Analyst / Administrator', 'Senior IT Specialist'],
    'Logistics': ['Warehouse/Logistics Leader', 'Senior Logistics Planner', 'Logistics Disponent', 'Logistics Planner', 'Packaging Disponent', 'Logistics Referent', 'Inventory Counter', 'Internal Logistics Coordinator', 'Logistics Shift leader', 'Expedient', 'Supervisor Inventory Control', 'Logistics Planner IM', 'Senior Demand Specialist', 'Logistics operator Expedient', 'Logistics operator receiving'],
    'Maintenance': ['Maintenance leader', 'Technician I', 'Technician II', 'Maintenance Shift Leader', 'Maintainer', 'Maintainer - mechanician', 'Maintainer - electrician', 'Energetic Coordinator', 'Robotist', 'Toolmaker', 'Maintenance Leader IM', 'Electrician IM', 'Mechanician IM', 'Maintainer - Toolmaker', 'Energetik/Facility Coordinator', 'Mechatronik', 'Toolmaker Coordinator and Maintenance Leader IM','Warehouse referent'],
    'Management': ['Operation Assistant General Manager', 'Financial Manager', 'HR Manager', 'Logistics Manager', 'Quality Manager', 'Production Manager', 'Maintenance Manager', 'Programme Manager', 'Purchasing Manager', 'IT Manager', 'Ext. Programme Manager', 'Business Manager', 'Program Manager'],
    'Production': ['Production Coordinator', 'Production Shift leader', 'Production Referent'],
    'Quality': ['Customer Quality Leader', 'Quality Leader', 'PPAP Technician', 'Quality Engineer QM System', 'Laboratory Leader/ Metrolog', 'Customer Quality Coordinator', 'Quality Auditors Coordinator', 'Supplier Quality Assurance', 'Sperrlager Coordinator', 'Sperrlager Quality Operator', 'Quality Auditor', 'Incoming Inspection', '3D Measurement', 'Laboratory technician', 'Resident']
};

// Source options
const sourceOptions = [
    'Manuvia',
    'Talent Solution',
    'Tobin',
    'Manpower',
    'TG',
    'TP Group',
    'Employee Referral',
    'LinkedIn',
    'Company Website',
    'University/College',
    'Job Fair',

];
document.getElementById('nav-statistics').addEventListener('click', showStatistics);


// DOM elements
const app = document.getElementById('app');
const navDashboard = document.getElementById('nav-dashboard');
const navCandidates = document.getElementById('nav-candidates');
const navRequests = document.getElementById('nav-requests');
const navGMApproval = document.getElementById('nav-gm-approval');
const navLogout = document.getElementById('nav-logout');
const navStatistics = document.getElementById('nav-statistics');

// Event listeners
navDashboard.addEventListener('click', showDashboard);
navCandidates.addEventListener('click', showCandidates);
navRequests.addEventListener('click', showRequests);
navGMApproval.addEventListener('click', showGMApproval);
navLogout.addEventListener('click', logout);
navStatistics.addEventListener('click', showStatistics);

// Global variable to store user role
let userRole = '';
let userDepartment = '';
let userAllowedPositions = [];

document.getElementById('nav-reports').addEventListener('click', showReports);


function debugUserInfo() {
    console.log('Current user role:', userRole);
    console.log('Current user department:', userDepartment);
}

// Update navigation visibility based on user role
function updateNavVisibility() {
    const navStatistics = document.getElementById('nav-statistics');
    const navReports = document.getElementById('nav-reports');
    const navGMApproval = document.getElementById('nav-gm-approval');
    const navRequests = document.getElementById('nav-requests');

    if (userRole === 'gm') {
        navGMApproval.style.display = 'inline';
        navRequests.style.display = 'inline';
        navStatistics.style.display = 'inline';
        navReports.style.display = 'inline';
    } else {
        navStatistics.style.display = 'none';
        navReports.style.display = 'none';
        navGMApproval.style.display = 'none';
        navRequests.style.display = userRole === 'recruiter' || userAllowedPositions.length === 0 ? 'inline' : 'none';
    }
}



// Login function
async function login(email, password) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
        alert('Error logging in: ' + error.message);
    } else {
        checkAuth();
    }
}

// Show login page
function showLogin() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('app-content').style.display = 'none';
    document.getElementById('auth-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        login(email, password);
    });
}

// Toggle visibility of login form and app content
function toggleVisibility(isLoggedIn) {
    document.getElementById('login-form').style.display = isLoggedIn ? 'none' : 'block';
    document.getElementById('app-content').style.display = isLoggedIn ? 'block' : 'none';
    if (isLoggedIn) {
        document.getElementById('app-content').classList.add('visible');
    } else {
        document.getElementById('app-content').classList.remove('visible');
    }
}

// Check authentication status
async function checkAuth() {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
        // Fetch user role, department, and allowed positions from your user table
        const { data, error } = await supabase
            .from('users')
            .select('role, department, allowed_positions')
            .eq('id', user.id)
            .single();

        if (data) {
            userRole = data.role;
            userDepartment = data.department;
            userAllowedPositions = data.allowed_positions || [];
        }

        toggleVisibility(true);
        showDashboard();
        updateNavVisibility();
    } else {
        toggleVisibility(false);
        showLogin();
    }
}
// Logout function
async function logout() {
    const supabase = getSupabase();
    if (!supabase) return;

    await supabase.auth.signOut();
    userRole = 'user';
    userDepartment = 'department';
    toggleVisibility(false);
    showLogin();
}

// Show login page
function showLogin() {
    app.innerHTML = `
        <h2>Login</h2>
        <form id="login-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
    `;
    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        login(email, password);
    });
}

// Show dashboard
function showDashboard() {
    app.innerHTML = `
        <h2 data-translate="Welcome to the Recruiting Management Dashboard!">Welcome to the Recruiting Management Dashboard!</h2>
        <div class="quick-actions">
            <button onclick="showAddCandidate()" class="btn btn-primary" data-translate="Add New Candidate">Add New Candidate</button>
            <button onclick="showNewRequest()" class="btn btn-primary" data-translate="Create Recruiting Request">Create Recruiting Request</button>
        </div>
    `;
    translatePage();
}

// Show candidates
async function showCandidates() {
    const supabase = getSupabase();
    if (!supabase) return;

    let query = supabase.from('candidates').select('*');

    // Filter candidates based on user permissions
    if (userRole !== 'gm') {
        if (userAllowedPositions.length > 0) {
            // User has specific position access
            query = query.in('position', userAllowedPositions);
        } else {
            // User has department-level access (manager)
            query = query.eq('department', userDepartment);
        }
    }

    const { data: candidates, error } = await query;
    const departments = [...new Set(candidates.map(c => c.department))];
    const positions = [...new Set(candidates.map(c => c.position))];
    const sources = [...new Set(candidates.map(c => c.source))];

    if (error) {
        app.innerHTML = `<p>Error loading candidates: ${error.message}</p>`;
        return;
    }



    let candidatesHtml = `
    <h2 data-translate="Candidates">Candidates</h2>
    <button onclick="showAddCandidate()" class="btn btn-primary" data-translate="Add New Candidate">Add New Candidate</button>
    <div class="filters">
        <select id="department-filter">
            <option value="" data-translate="All Departments">All Departments</option>
            ${departments.map(dept => `<option value="${dept}">${dept}</option>`).join('')}
        </select>
        <select id="position-filter">
            <option value="" data-translate="All Positions">All Positions</option>
            ${positions.map(pos => `<option value="${pos}">${pos}</option>`).join('')}
        </select>
        <select id="source-filter">
            <option value="" data-translate="All Sources">All Sources</option>
            ${sources.map(src => `<option value="${src}">${src}</option>`).join('')}
        </select>
    </div>
    <button onclick="applyFilters()" class="btn btn-secondary" data-translate="Apply Filters">Apply Filters</button>
    <div id="candidates-table"></div>
`;


    app.innerHTML = candidatesHtml;
    renderCandidatesTable(candidates);
    translatePage();
}

function renderCandidatesTable(candidates) {
    const tableContainer = document.getElementById('candidates-table');
    const inProcessCandidates = candidates.filter(c => ['New', 'In Process', 'Rejected - Inform Source', 'Hired - Contact Source', 'In Process - First Round', 'In Process - Second Round', 'In Process 1st Round', 'In Process 2nd Round'].includes(c.status));
    const hiredCandidates = candidates.filter(c => c.status === 'Hired');
    const rejectedCandidates = candidates.filter(c => c.status === 'Rejected');

    let tableHtml = `
        <h3 data-translate="Candidates in Process">Candidates in Process</h3>
        ${generateCandidateTable(inProcessCandidates)}

        <h3 data-translate="Hired Candidates">Hired Candidates</h3>
        ${generateCandidateTable(hiredCandidates)}

        <h3 data-translate="Rejected Candidates">Rejected Candidates</h3>
        ${generateCandidateTable(rejectedCandidates)}
    `;

    tableContainer.innerHTML = tableHtml;
}

function applyFilters() {
    const departmentFilter = document.getElementById('department-filter').value;
    const positionFilter = document.getElementById('position-filter').value;
    const sourceFilter = document.getElementById('source-filter').value;

    const supabase = getSupabase();
    if (!supabase) return;

    let query = supabase.from('candidates').select('*');

    if (departmentFilter) {
        query = query.eq('department', departmentFilter);
    } else if (userRole !== 'gm') {
        query = query.eq('department', userDepartment);
    }

    if (positionFilter) {
        query = query.eq('position', positionFilter);
    }

    if (sourceFilter) {
        query = query.eq('source', sourceFilter);
    }

    query.then(({ data: filteredCandidates, error }) => {
        if (error) {
            console.error('Error applying filters:', error);
            return;
        }
        renderCandidatesTable(filteredCandidates);
    });
    translatePage();
}

function generateCandidateTable(candidates) {
    if (candidates.length === 0) {
        return `<p data-translate="No candidates found.">No candidates found.</p>`;
    }

    const statusOrder = [
        'New',
        'In Process - First Round',
        'In Process - Second Round',
        'Hired - Contact Source',
        'Rejected - Inform Source',
        'Hired',
        'Rejected',
    ];

    const groupedCandidates = candidates.reduce((acc, candidate) => {
        if (!acc[candidate.status]) {
            acc[candidate.status] = [];
        }
        acc[candidate.status].push(candidate);
        return acc;
    }, {});

    let tableHtml = '';

    statusOrder.forEach((status) => {
        if (groupedCandidates[status] && groupedCandidates[status].length > 0) {
            tableHtml += `
                <div class="status-group">
                    <h3 class="status-header">${translate(status)}</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th data-translate="Name">Name</th>
                                    <th data-translate="Department">Department</th>
                                    <th data-translate="Position">Position</th>
                                    <th data-translate="Source">Source</th>
                                    <th data-translate="Date Obtained">Date Obtained</th>
                                    <th data-translate="Interviewer">Interviewer</th>
                                    <th data-translate="Time in Process">Time in Process</th>
                                    <th data-translate="Documents">Documents</th>
                                    <th data-translate="Notes">Notes</th>
                                    <th data-translate="Actions">Actions</th>
                                    <th data-translate="Admin Actions">Admin Actions</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            groupedCandidates[status].forEach(candidate => {
                const timeInProcess = calculateTimeInProcess(candidate.last_updated);
                const alertClass = timeInProcess.days > 7 ? 'alert-status' : '';

                let managerActions = '';
                let adminActions = `<button onclick="showCandidateDetails(${candidate.id})" class="btn btn-info">View Details</button>`;

                // Generate action buttons based on candidate status
                switch (candidate.status) {
                    case 'New':
                        managerActions = `
                            <button onclick="inviteCandidate(${candidate.id})" class="btn btn-primary" data-translate="Invite">Invite</button>
                            <button onclick="rejectCandidate(${candidate.id})" class="btn btn-danger" data-translate="Reject">Reject</button>
                        `;
                        break;
                    case 'In Process - First Round':
                        managerActions = `
                            <button onclick="secondRound(${candidate.id})" class="btn btn-primary" data-translate="Second Round">Second Round</button>
                            <button onclick="hireCandidate(${candidate.id})" class="btn btn-success" data-translate="Hire">Hire</button>
                            <button onclick="rejectCandidate(${candidate.id})" class="btn btn-danger" data-translate="Reject">Reject</button>
                        `;
                        break;
                    case 'In Process - Second Round':
                        managerActions = `
                            <button onclick="hireCandidate(${candidate.id})" class="btn btn-success" data-translate="Hire">Hire</button>
                            <button onclick="rejectCandidate(${candidate.id})" class="btn btn-danger" data-translate="Reject">Reject</button>
                        `;
                        break;
                    case 'Rejected - Inform Source':
                        managerActions = `
                            <button onclick="rejectedSourceInformed(${candidate.id})" class="btn btn-success" data-translate="Rejected - Source Informed">Rejected - Source Informed</button>
                        `;
                        break;
                    case 'Hired - Contact Source':
                        managerActions = `
                            <button onclick="hiredSourceInformed(${candidate.id})" class="btn btn-danger" data-translate="Hired - Source Informed">Hired - Source Informed</button>
                        `;
                        break;
                }

                let documentsHtml = '';
                if (candidate.cv_file_path) {
                    documentsHtml += `<button onclick="downloadFile(${candidate.id}, 'cv')" class="btn btn-secondary" data-translate="Download CV">Download CV</button>`;
                }
                if (candidate.assesment_file_path) {
                    documentsHtml += `<button onclick="downloadFile(${candidate.id}, 'assessment')" class="btn btn-secondary" data-translate="Download Assessment">Download Assessment</button>`;
                }
                if (!documentsHtml) {
                    documentsHtml = '<span data-translate="No documents">No documents</span>';
                }

                tableHtml += `
                    <tr class="${alertClass}">
                        <td>${candidate.name || ''}</td>
                        <td>${candidate.department || ''}</td>
                        <td>${candidate.position || ''}</td>
                        <td>${candidate.source || ''}</td>
                        <td>${candidate.date_obtained || ''}</td>
                        <td>${candidate.interviewer || ''}</td>
                        <td>${formatTimeInProcess(timeInProcess)}</td>
                        <td>${documentsHtml}</td>
                        <td>${candidate.notes ? `<div class="notes-cell">${candidate.notes}</div>` : '<span data-translate="No notes">No notes</span>'}</td>
                        <td>${managerActions}</td>
                        <td>${adminActions}</td>
                    </tr>
                `;
            });

            tableHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
    });

    return tableHtml;
}

function calculateTimeInProcess(lastUpdated) {
    const now = new Date();
    const updated = new Date(lastUpdated);
    const diffTime = Math.abs(now - updated);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor((diffTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

    return { days: diffDays, hours: diffHours };
}

function formatTimeInProcess(time) {
    if (time.days > 0) {
        return `${time.days} ${time.days === 1 ? translate('day') : translate('days')}`;
    } else {
        return `${time.hours} ${time.hours === 1 ? translate('hour') : translate('hours')}`;
    }
}

async function inviteCandidate(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data, error } = await supabase
        .from('candidates')
        .update({ status: 'In Process - First Round' })
        .eq('id', id);

    if (error) {
        alert('Error updating candidate status: ' + error.message);
    } else {
        alert('Candidate invited to first round interview.');
        showCandidates();
    }
}

async function rejectCandidate(id) {
    const reason = prompt('Please enter the reason for rejecting this candidate:');
    if (reason === null) return; // User cancelled the prompt

    const supabase = getSupabase();
    if (!supabase) return;

    // First, fetch the current candidate data
    const { data: candidateData, error: fetchError } = await supabase
        .from('candidates')
        .select('notes')
        .eq('id', id)
        .single();

    if (fetchError) {
        alert('Error fetching candidate data: ' + fetchError.message);
        return;
    }

    // Prepare the new notes by appending the termination reason
    const currentDate = new Date().toISOString().split('T')[0]; // Get current date in YYYY-MM-DD format
    const terminationNote = `[${currentDate}] Termination reason: ${reason}`;
    const newNotes = candidateData.notes
        ? `${candidateData.notes}\n\n${terminationNote}`
        : terminationNote;

    // Update the candidate status and notes
    const { data, error } = await supabase
        .from('candidates')
        .update({
            status: 'Rejected - Inform Source',
            notes: newNotes
        })
        .eq('id', id);

    if (error) {
        alert('Error updating candidate status: ' + error.message);
    } else {
        alert('Candidate rejected. Please inform the source.');
        showCandidates();
    }
}

async function rejectedSourceInformed(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data, error } = await supabase
        .from('candidates')
        .update({ status: 'Rejected' })
        .eq('id', id);

    if (error) {
        alert('Error updating candidate status: ' + error.message);
    } else {
        alert('Source informed. Candidate status updated to Rejected.');
        showCandidates();
    }
}

async function secondRound(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data, error } = await supabase
        .from('candidates')
        .update({ status: 'In Process - Second Round' })
        .eq('id', id);

    if (error) {
        alert('Error updating candidate status: ' + error.message);
    } else {
        alert('Candidate moved to second round interview.');
        showCandidates();
    }
}

async function hireCandidate(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data, error } = await supabase
        .from('candidates')
        .update({ status: 'Hired - Contact Source' })
        .eq('id', id);

    if (error) {
        alert('Error updating candidate status: ' + error.message);
    } else {
        alert('Candidate hired. Please contact the source.');
        showCandidates();
    }
}

async function hiredSourceInformed(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data, error } = await supabase
        .from('candidates')
        .update({ status: 'Hired' })
        .eq('id', id);

    if (error) {
        alert('Error updating candidate status: ' + error.message);
    } else {
        alert('Source informed. Candidate status updated to Hired.');
        showCandidates();
    }
}

async function downloadFile(candidateId, fileType) {
    const supabase = getSupabase();
    if (!supabase) return;

    try {
        // Get the file path from the candidates table
        const { data: candidateData, error: candidateError } = await supabase
            .from('candidates')
            .select(fileType === 'cv' ? 'cv_file_path' : 'assessment_file_path')
            .eq('id', candidateId)
            .single();

        if (candidateError) throw candidateError;

        const filePath = fileType === 'cv' ? candidateData.cv_file_path : candidateData.assessment_file_path;

        if (!filePath) {
            alert(`No ${fileType.toUpperCase()} file found for this candidate.`);
            return;
        }

        // Download the file using the stored path
        const { data, error } = await supabase.storage
            .from('candidate-files')
            .download(filePath);

        if (error) throw error;

        // Create a blob from the file data and trigger download
        const blob = new Blob([data], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = `${fileType}_${candidateId}.pdf`;
        link.click();
    } catch (error) {
        console.error(`Error downloading ${fileType}:`, error);
        alert(`Error downloading ${fileType}. Please try again.`);
    }
}




// Delete candidate
async function deleteCandidate(id) {
    if (!confirm('Are you sure you want to delete this candidate?')) {
        return;
    }

    const supabase = getSupabase();
    if (!supabase) return;

    // Delete candidate files
    const { data: files, error: filesError } = await supabase.storage
        .from('candidate-files')
        .list(`${id}`);

    if (files && files.length > 0) {
        for (const file of files) {
            await supabase.storage
                .from('candidate-files')
                .remove([`${id}/${file.name}`]);
        }
    }

    // Delete candidate record
    const { error } = await supabase
        .from('candidates')
        .delete()
        .eq('id', id);

    if (error) {
        alert('Error deleting candidate: ' + error.message);
    } else {
        alert('Candidate deleted successfully');
        showCandidates();
    }
}

// Show add candidate form
function showAddCandidate() {
    let departmentOptions = '';

    if (userRole === 'gm') {
        departmentOptions = Object.keys(departmentPositions).map(dept =>
            `<option value="${dept}">${dept}</option>`
        ).join('');
    } else {
        departmentOptions = `<option value="${userDepartment}">${userDepartment}</option>`;
    }

    app.innerHTML = `
        <h2 data-translate="Add New Candidate">Add New Candidate</h2>
        <form id="add-candidate-form">
            <div class="form-group">
                <label for="name" class="required" data-translate="Full Name">Full Name</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="department" class="required" data-translate="Department">Department</label>
                <select id="department" required onchange="updatePositionOptions()">
                    <option value="" data-translate="Select a department">Select a department</option>
                    ${Object.keys(departmentPositions).map(dept => `<option value="${dept}">${dept}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label for="position" class="required" data-translate="Position">Position</label>
                <select id="position" required>
                    <option value="" data-translate="Select a department first">Select a department first</option>
                </select>
            </div>
            <div class="form-group">
                <label for="source" class="required" data-translate="Source">Source</label>
                <select id="source" required>
                    <option value="" data-translate="Select a source">Select a source</option>
                    ${sourceOptions.map(source => `<option value="${source}">${source}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label for="date_obtained" class="required" data-translate="Date Obtained">Date Obtained</label>
                <input type="date" id="date_obtained" required>
            </div>
            <div class="form-group">
                <label for="cv" data-translate="Upload CV">Upload CV</label>
                <input type="file" id="cv" accept=".pdf,.doc,.docx">
            </div>
            <div class="form-group">
                <label for="assessment" data-translate="Upload Assessment Form">Upload Assessment Form</label>
                <input type="file" id="assessment" accept=".pdf,.doc,.docx">
            </div>
            <div class="form-group">
                <label for="interviewer" data-translate="Interviewer">Interviewer</label>
                <input type="text" id="interviewer">
            </div>
            <div class="form-group">
                <label for="status" data-translate="Status">Status</label>
                <select id="status">
                    <option value="New" data-translate="New">New</option>
                    <option value="In Process - First Round" data-translate="In Process - First Round">In Process - First Round</option>
                    <option value="In Process - Second Round" data-translate="In Process - Second Round">In Process - Second Round</option>
                    <option value="Hired" data-translate="Hired">Hired</option>
                    <option value="Rejected" data-translate="Rejected">Rejected</option>
                </select>
            </div>
            <div class="form-group">
                <label for="notes" data-translate="Notes">Notes</label>
                <textarea id="notes"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" data-translate="Add Candidate">Add Candidate</button>
        </form>
    `;
    document.getElementById('add-candidate-form').addEventListener('submit', addCandidate);
    document.getElementById('name').addEventListener('blur', async function() {
        const name = this.value;
        if (name) {
            const existingCandidates = await checkExistingCandidate(name);
            if (existingCandidates) {
                alert(`Warning: Candidates with similar names already exist:\n${existingCandidates.map(c => c.name).join('\n')}`);
            }
        }
    });
    translatePage();
}



// Update position options based on selected department
function updatePositionOptions() {
    const departmentSelect = document.getElementById('department');
    const positionSelect = document.getElementById('position');
    const selectedDepartment = departmentSelect.value;

    positionSelect.innerHTML = '<option value="">Select a position</option>';

    if (selectedDepartment && departmentPositions[selectedDepartment]) {
        departmentPositions[selectedDepartment].forEach(position => {
            const option = document.createElement('option');
            option.value = position;
            option.textContent = position;
            positionSelect.appendChild(option);
        });
    }
}

async function displayNotifications() {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        console.error('No authenticated user');
        return;
    }

    const { data: notifications, error } = await supabase
        .from('notifications')
        .select('*')
        .eq('email', user.email)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching notifications:', error);
        return;
    }

    const notificationsList = document.getElementById('notifications-list');
    notificationsList.innerHTML = '';

    notifications.forEach(notification => {
        const notificationElement = document.createElement('div');
        notificationElement.className = 'notification';
        notificationElement.textContent = notification.message;
        notificationsList.appendChild(notificationElement);
    });
}



async function addCandidate(e) {
    e.preventDefault();
    const supabase = getSupabase();
    if (!supabase) return;

    const name = document.getElementById('name').value;
    const department = document.getElementById('department').value;
    const position = document.getElementById('position').value;
    const source = document.getElementById('source').value;
    const date_obtained = document.getElementById('date_obtained').value;
    const interviewer = document.getElementById('interviewer').value;
    const status = 'New'; // Preset status as New


    // Validate required fields
    if (!name || !department || !position || !source || !date_obtained) {
        alert('Please fill in all required fields.');
        return;
    }

    // Check for existing candidate
    const existingCandidates = await checkExistingCandidate(name);
    if (existingCandidates) {
        const confirmAdd = confirm(`A candidate with the name "${name}" already exists. Do you still want to add this candidate?\n\nExisting candidates:\n${existingCandidates.map(c => c.name).join('\n')}`);
        if (!confirmAdd) {
            return;
        }
    }

    try {
        let cvPath = null;
        let assessmentPath = null;

        // Handle CV upload
        const cvFile = document.getElementById('cv').files[0];
        if (cvFile) {
            const { data: cvData, error: cvError } = await supabase.storage
                .from('candidate-files')
                .upload(`cv_${Date.now()}.pdf`, cvFile);

            if (cvError) throw cvError;
            cvPath = cvData.path;
        }

        // Handle Assessment Form upload
        const assessmentFile = document.getElementById('assessment').files[0];
        if (assessmentFile) {
            const { data: assessmentData, error: assessmentError } = await supabase.storage
                .from('candidate-files')
                .upload(`assessment_${Date.now()}.pdf`, assessmentFile);

            if (assessmentError) throw assessmentError;
            assessmentPath = assessmentData.path;
        }

        // Insert candidate data
        const { data, error } = await supabase
            .from('candidates')
            .insert([{
                name,
                department,
                position,
                source,
                date_obtained,
                interviewer,
                status,
                notes,
                cv_file_path: cvPath,
                assesment_file_path: assessmentPath
            }]);

        if (error) throw error;

        alert('Candidate added successfully!');
        showCandidates();
    } catch (error) {
        console.error('Error adding candidate:', error);
        alert('Error adding candidate: ' + error.message);
    }
}

// Show candidate details
async function showCandidateDetails(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data: candidate, error } = await supabase
        .from('candidates')
        .select('*')
        .eq('id', id)
        .single();

    if (error) {
        app.innerHTML = `<p>Error loading candidate details: ${error.message}</p>`;
        return;
    }

    console.log('Candidate details:', candidate);  // Log candidate details for debugging

    let cvHtml = candidate.cv_file_path
        ? `<p><strong>CV:</strong> <button onclick="downloadFile(${candidate.id}, 'cv')" class="btn btn-secondary">Download CV</button></p>`
        : '<p><strong>CV:</strong> No CV uploaded</p>';

    app.innerHTML = `
        <h2>Candidate Details</h2>
        <div class="candidate-details">
            <p><strong>Name:</strong> ${candidate.name}</p>
            <p><strong>Department:</strong> ${candidate.department}</p>
            <p><strong>Position:</strong> ${candidate.position}</p>
            <p><strong>Source:</strong> ${candidate.source}</p>
            <p><strong>Date Obtained:</strong> ${candidate.date_obtained}</p>
            <p><strong>Interviewer:</strong> ${candidate.interviewer || 'Not assigned'}</p>
            <p><strong>Status:</strong> ${candidate.status}</p>
            <p><strong>Notes:</strong> ${candidate.notes || 'No notes'}</p>
            ${cvHtml}
        </div>
        <button onclick="showEditCandidate(${candidate.id})" class="btn btn-primary">Edit Candidate</button>
        <button onclick="deleteCandidate(${candidate.id})" class="btn btn-danger">Delete Candidate</button>
        <button onclick="showCandidates()" class="btn btn-secondary">Back to Candidates</button>
    `;
}

// Show edit candidate form
async function showEditCandidate(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data: candidate, error } = await supabase
        .from('candidates')
        .select('*')
        .eq('id', id)
        .single();

    if (error) {
        app.innerHTML = `<p>Error loading candidate details: ${error.message}</p>`;
        return;
    }

    app.innerHTML = `
        <h2>Edit Candidate</h2>
        <form id="edit-candidate-form">
            <input type="hidden" id="candidate-id" value="${candidate.id}">
            <div class="form-group">
                <label for="name" class="required">Full Name</label>
                <input type="text" id="name" value="${candidate.name}" required>
            </div>
            <div class="form-group">
                <label for="department" class="required">Department</label>
                <select id="department" required onchange="updatePositionOptions()">
                    <option value="">Select a department</option>
                    ${Object.keys(departmentPositions).map(dept => `<option value="${dept}" ${candidate.department === dept ? 'selected' : ''}>${dept}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label for="position" class="required">Position</label>
                <select id="position" required>
                    <option value="">Select a position</option>
                    ${departmentPositions[candidate.department].map(pos => `<option value="${pos}" ${candidate.position === pos ? 'selected' : ''}>${pos}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label for="source" class="required">Source</label>
                <select id="source" required>
                    <option value="">Select a source</option>
                    ${sourceOptions.map(source => `<option value="${source}" ${candidate.source === source ? 'selected' : ''}>${source}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label for="date_obtained" class="required">Date Obtained</label>
                <input type="date" id="date_obtained" value="${candidate.date_obtained}" required>
            </div>
            <div class="form-group">
                <label for="cv">Upload CV</label>
                <input type="file" id="cv" accept=".pdf,.doc,.docx">
            </div>
            <div class="form-group">
                <label for="assessment">Upload Assessment Form</label>
                <input type="file" id="assessment" accept=".pdf,.doc,.docx">
            </div>
            <div class="form-group">
                <label for="interviewer">Interviewer</label>
                <input type="text" id="interviewer" value="${candidate.interviewer || ''}">
            </div>
            <div class="form-group">
                <label for="status">Status</label>
                <select id="status">
                    <option value="">Select a status</option>
                    <option value="New" ${candidate.status === 'New' ? 'selected' : ''}>New</option>
                    <option value="In Process - First Round" ${candidate.status === 'In Process - First Round' ? 'selected' : ''}>In Process - First Round</option>
                    <option value="In Process - Second Round" ${candidate.status === 'In Process - Second Round' ? 'selected' : ''}>In Process - Second Round</option>
                    <option value="Hired - Contact Source" ${candidate.status === 'Hired - Contact Source' ? 'selected' : ''}>Hired - Contact Source</option>
                    <option value="Rejected - Inform Source" ${candidate.status === 'Rejected - Inform Source' ? 'selected' : ''}>Rejected - Inform Source</option>
                    <option value="Hired" ${candidate.status === 'Hired' ? 'selected' : ''}>Hired</option>
                    <option value="Rejected" ${candidate.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                </select>
            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes">${candidate.notes || ''}</textarea>
            </div>
            <button type="submit" class="btn btn-primary">Update Candidate</button>
        </form>
        <button onclick="showCandidates()" class="btn btn-primary">Back to Candidates</button>
    `;
    document.getElementById('edit-candidate-form').addEventListener('submit', updateCandidate);
}

// Update candidate
async function updateCandidate(e) {
    e.preventDefault();
    const supabase = getSupabase();
    if (!supabase) return;

    const id = document.getElementById('candidate-id').value;
    const name = document.getElementById('name').value;
    const department = document.getElementById('department').value;
    const position = document.getElementById('position').value;
    const source = document.getElementById('source').value;
    const date_obtained = document.getElementById('date_obtained').value;
    const interviewer = document.getElementById('interviewer').value;
    const status = document.getElementById('status').value;
    const notes = document.getElementById('notes').value;

    // Validate required fields
    if (!name || !department || !position || !source || !date_obtained) {
        alert('Please fill in all required fields.');
        return;
    }

    try {
        let updateData = {
            name,
            department,
            position,
            source,
            date_obtained,
            interviewer,
            status,
            notes
        };

        // Handle CV upload
        const cvFile = document.getElementById('cv').files[0];
        if (cvFile) {
            const { data: cvData, error: cvError } = await supabase.storage
                .from('candidate-files')
                .upload(`cv_${id}_${Date.now()}.pdf`, cvFile);

            if (cvError) throw cvError;
            updateData.cv_file_path = cvData.path;
        }

        // Update the candidate record
        const { data, error } = await supabase
            .from('candidates')
            .update(updateData)
            .eq('id', id);

        if (error) throw error;

        alert('Candidate updated successfully!');
        showCandidateDetails(id);
    } catch (error) {
        console.error('Error updating candidate:', error);
        alert('Error updating candidate: ' + error.message);
    }
}

// Show recruiting requests
function showNewRequest() {
    let departmentOptions = '';

    if (userRole === 'gm') {
        departmentOptions = Object.keys(departmentPositions).map(dept =>
            `<option value="${dept}">${dept}</option>`
        ).join('');
    } else {
        departmentOptions = `<option value="${userDepartment}">${userDepartment}</option>`;
    }

    app.innerHTML = `
        <h2 data-translate="Create New Recruiting Request">Create New Recruiting Request</h2>
        <form id="new-request-form">
            <div class="form-group">
                <label for="department" data-translate="Department">Department:</label>
                <select id="department" required ${userRole !== 'gm' ? 'disabled' : ''} onchange="updatePositionOptions()">
                    ${departmentOptions}
                </select>
            </div>
            <div class="form-group">
                <label for="position" data-translate="Position">Position:</label>
                <select id="position" required>
                    <option value="" data-translate="Select Position">Select Position</option>
                </select>
            </div>
            <div class="form-group">
                <label for="description" data-translate="Job Description">Job Description:</label>
                <textarea id="description" required></textarea>
            </div>
            <div class="form-group">
                <label for="headcount" data-translate="Headcount">Headcount:</label>
                <input type="number" id="headcount" required min="1" value="1">
            </div>
            <div class="form-group">
                <label data-translate="Position Type">Position Type:</label>
                <div>
                    <label>
                        <input type="radio" id="new-position" name="position-type" value="new" required onchange="togglePositionTypeFields()">
                        <span data-translate="New Position">New Position</span>
                    </label>
                    <label>
                        <input type="radio" id="replacement" name="position-type" value="replacement" required onchange="togglePositionTypeFields()">
                        <span data-translate="Replacement">Replacement</span>
                    </label>
                </div>
            </div>
            <div id="new-position-fields" class="hidden">
                <div class="form-group">
                    <label for="new-position-reason" data-translate="Reason for New Position">Reason for New Position:</label>
                    <textarea id="new-position-reason"></textarea>
                </div>
            </div>
            <div id="replacement-fields" class="hidden">
                <div class="form-group">
                    <label for="replacement-name" data-translate="Name of Person Being Replaced">Name of Person Being Replaced:</label>
                    <input type="text" id="replacement-name">
                </div>
            </div>
            <div class="form-group">
                <label data-translate="Position Category">Position Category:</label>
                <div>
                    <label>
                        <input type="radio" id="sal-position" name="position-category" value="SAL" required>
                        <span data-translate="SAL">SAL</span>
                    </label>
                    <label>
                        <input type="radio" id="ind-position" name="position-category" value="IND" required>
                        <span data-translate="IND">IND</span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="confidential-request">
                    <span data-translate="Confidential Request">Confidential Request</span>
                </label>
            </div>
            <button type="submit" class="btn btn-primary" data-translate="Submit Request">Submit Request</button>
        </form>
    `;

    document.getElementById('new-request-form').addEventListener('submit', createRequest);
    updatePositionOptions(); // Initialize position options
    applyTranslations(); // Apply translations after rendering content
}

function confirmDeleteRequest(id) {
    if (confirm("Are you sure you want to delete this request? This action cannot be undone.")) {
        deleteRequest(id);
    }
}

function togglePositionTypeFields() {
    const newPositionFields = document.getElementById('new-position-fields');
    const replacementFields = document.getElementById('replacement-fields');
    const positionType = document.querySelector('input[name="position-type"]:checked').value;

    if (positionType === 'new') {
        newPositionFields.classList.remove('hidden');
        replacementFields.classList.add('hidden');
    } else {
        newPositionFields.classList.add('hidden');
        replacementFields.classList.remove('hidden');
    }
}

// Delete request
async function deleteRequest(id) {
    const supabase = getSupabase();
    if (!supabase) {
        alert("Error: Supabase client not initialized");
        return;
    }

    try {
        const { error } = await supabase
            .from('recruiting_requests')
            .delete()
            .eq('id', id);

        if (error) throw error;

        alert("Request deleted successfully.");
        showRequests(); // Refresh the list
    } catch (error) {
        console.error("Error deleting request:", error);
        alert(`Failed to delete request: ${error.message}`);
    }
}

// Show new request form
async function showRequests() {
    const supabase = getSupabase();
    if (!supabase) return;

    let query = supabase.from('recruiting_requests').select('*');

    // Filter by department for non-GM users
    if (userRole !== 'gm') {
        query = query.eq('department', userDepartment);
    }

    const { data: requests, error } = await query;

    if (error) {
        app.innerHTML = `<p>Error loading recruiting requests: ${error.message}</p>`;
        return;
    }

    // Group requests by status
    const groupedRequests = requests.reduce((acc, request) => {
        if (!acc[request.status]) {
            acc[request.status] = [];
        }
        acc[request.status].push(request);
        return acc;
    }, {});

    // Define the desired order of statuses
    const statusOrder = ['New', 'Approved', 'Pending', 'Rejected', 'Filled'];

    let requestsHtml = `
        <h2 data-translate="Recruiting Requests">Recruiting Requests</h2>
        <button onclick="showNewRequest()" class="btn btn-primary" data-translate="Create New Request">Create New Request</button>
    `;

    statusOrder.forEach(status => {
        if (groupedRequests[status] && groupedRequests[status].length > 0) {
            requestsHtml += `
                    <div class="status-group ${status.toLowerCase()}">
                        <h3 class="status-header" data-translate="${status} Requests">${status} Requests</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th data-translate="Position">Position</th>
                                        <th data-translate="Department">Department</th>
                                        <th data-translate="Headcount">Headcount</th>
                                        <th data-translate="Type">Type</th>
                                        <th data-translate="Category">Category</th>
                                        <th data-translate="Confidential">Confidential</th>
                                        <th data-translate="Actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

            groupedRequests[status].forEach(request => {
                requestsHtml += `
                        <tr>
                            <td>${request.position}</td>
                            <td>${request.department}</td>
                            <td>${request.headcount}</td>
                            <td>${request.position_type}</td>
                            <td>${request.position_category}</td>
                            <td>${request.is_confidential ? 'Yes' : 'No'}</td>
                            <td>
                                <button onclick="showRequestDetails(${request.id})" class="btn btn-info" data-translate="View Details">View Details</button>
                                ${userRole === 'gm' && status === 'Pending' ? `
                                    <button onclick="approveRequest(${request.id})" class="btn btn-success" data-translate="Approve">Approve</button>
                                    <button onclick="rejectRequest(${request.id})" class="btn btn-danger" data-translate="Reject">Reject</button>
                                ` : ''}
                                ${status !== 'Filled' ? `<button onclick="deleteRequest(${request.id})" class="btn btn-secondary" data-translate="Delete">Delete</button>` : ''}
                                ${status === 'Approved' ? `<button onclick="fillPosition(${request.id})" class="btn btn-primary" data-translate="Position Filled">Position Filled</button>` : ''}
                            </td>
                        </tr>
                    `;
            });

            requestsHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
        }
    });

    app.innerHTML = requestsHtml;
    applyTranslations(); // Apply translations after rendering content
}

async function fillPosition(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    try {
        const { data, error } = await supabase
            .from('recruiting_requests')
            .update({ status: 'Filled' })
            .eq('id', id);

        if (error) throw error;

        alert('Position marked as filled successfully!');
        showRequests();
    } catch (error) {
        console.error('Error filling position:', error);
        alert('Error filling position: ' + error.message);
    }
}

async function createRequest(e) {
    e.preventDefault();
    const supabase = getSupabase();
    if (!supabase) {
        console.error('Supabase client not initialized');
        alert('Error: Supabase client not initialized');
        return;
    }

    const department = document.getElementById('department').value;
    const position = document.getElementById('position').value;
    const description = document.getElementById('description').value;
    const headcount = parseInt(document.getElementById('headcount').value, 10);
    const positionType = document.querySelector('input[name="position-type"]:checked')?.value;
    const positionCategory = document.querySelector('input[name="position-category"]:checked')?.value;
    const isConfidential = document.getElementById('confidential-request').checked;

    let newPositionReason = null;
    let replacementName = null;

    if (positionType === 'new') {
        newPositionReason = document.getElementById('new-position-reason').value;
    } else if (positionType === 'replacement') {
        replacementName = document.getElementById('replacement-name').value;
    }

    // Validation
    if (!department || !position || !description || !headcount || !positionType || !positionCategory) {
        alert('Please fill in all required fields');
        return;
    }

    const requestData = {
        position,
        department,
        description,
        headcount,
        status: 'Pending',
        position_type: positionType,
        position_category: positionCategory,
        is_confidential: isConfidential,
        new_position_reason: newPositionReason,
        replacement_name: replacementName
    };

    console.log('Request data to be sent:', requestData);

    try {
        const { data, error } = await supabase
            .from('recruiting_requests')
            .insert([requestData])
            .select();

        if (error) throw error;

        if (!data || data.length === 0) {
            throw new Error('No data returned from insert operation');
        }

        console.log('Request created successfully:', data[0]);

        // Notify GM (commented out for now)
        // If you want to implement this feature, you'll need to create a separate function
        // and ensure it's properly set up in your Supabase project

        try {
            const { data: emailData, error: emailError } = await supabase.functions.invoke('send-gm-email', {
                body: { requestId: data[0].id, position, department },
            });

            if (emailError) {
                console.error('Error sending email to GMs:', emailError);
            } else {
                console.log('Email sent successfully to GMs:', emailData);
            }
        } catch (emailError) {
            console.error('Error invoking send-gm-email function:', emailError);
        }

        alert('Request created successfully!');
        showRequests();
    } catch (error) {
        console.error('Error creating request:', error);
        alert('Error creating request: ' + error.message);
    }
    applyTranslations(); // Apply translations after rendering content
}
async function sendNewCandidateEmail(candidate) {
    const supabase = getSupabase();
    if (!supabase) {
        console.error('Supabase client not initialized');
        return;
    }

    try {
        const { data: emailData, error: emailError } = await supabase.functions.invoke('send-candidate-email', {
            body: {
                candidateId: candidate.id,
                name: candidate.name,
                position: candidate.position,
                department: candidate.department
            },
        });

        if (emailError) {
            console.error('Error sending email about new candidate:', emailError);
        } else {
            console.log('Email sent successfully:', emailData);
        }
    } catch (emailError) {
        console.error('Error invoking send-candidate-email function:', emailError);
    }
}

function showNewRequest() {
    let departmentOptions = '';

    if (userRole === 'gm') {
        departmentOptions = Object.keys(departmentPositions).map(dept =>
            `<option value="${dept}">${dept}</option>`
        ).join('');
    } else {
        departmentOptions = `<option value="${userDepartment}">${userDepartment}</option>`;
    }

    app.innerHTML = `
        <h2 data-translate="Create New Recruiting Request">Create New Recruiting Request</h2>
        <form id="new-request-form">
            <div class="form-group">
                <label for="department" data-translate="Department">Department:</label>
                <select id="department" required ${userRole !== 'gm' ? 'disabled' : ''} onchange="updatePositionOptions()">
                    ${departmentOptions}
                </select>
            </div>
            <div class="form-group">
                <label for="position" data-translate="Position">Position:</label>
                <select id="position" required>
                    <option value="" data-translate="Select Position">Select Position</option>
                </select>
            </div>
            <div class="form-group">
                <label for="description" data-translate="Job Description">Job Description:</label>
                <textarea id="description" required></textarea>
            </div>
            <div class="form-group">
                <label for="headcount" data-translate="Headcount">Headcount:</label>
                <input type="number" id="headcount" required min="1" value="1">
            </div>
            <div class="form-group">
                <label data-translate="Position Type">Position Type:</label>
                <div>
                    <label>
                        <input type="radio" id="new-position" name="position-type" value="new" required onchange="togglePositionTypeFields()">
                        <span data-translate="New Position">New Position</span>
                    </label>
                    <label>
                        <input type="radio" id="replacement" name="position-type" value="replacement" required onchange="togglePositionTypeFields()">
                        <span data-translate="Replacement">Replacement</span>
                    </label>
                </div>
            </div>
            <div id="new-position-fields" class="hidden">
                <div class="form-group">
                    <label for="new-position-reason" data-translate="Reason for New Position">Reason for New Position:</label>
                    <textarea id="new-position-reason"></textarea>
                </div>
            </div>
            <div id="replacement-fields" class="hidden">
                <div class="form-group">
                    <label for="replacement-name" data-translate="Name of Person Being Replaced">Name of Person Being Replaced:</label>
                    <input type="text" id="replacement-name">
                </div>
            </div>
            <div class="form-group">
                <label data-translate="Position Category">Position Category:</label>
                <div>
                    <label>
                        <input type="radio" id="sal-position" name="position-category" value="SAL" required>
                        <span data-translate="SAL">SAL</span>
                    </label>
                    <label>
                        <input type="radio" id="ind-position" name="position-category" value="IND" required>
                        <span data-translate="IND">IND</span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="confidential-request">
                    <span data-translate="Confidential Request">Confidential Request</span>
                </label>
            </div>
            <button type="submit" class="btn btn-primary" data-translate="Submit Request">Submit Request</button>
        </form>
    `;

    document.getElementById('new-request-form').addEventListener('submit', createRequest);
    updatePositionOptions(); // Initialize position options
    applyTranslations(); // Apply translations after rendering content
}

// Show request details
async function showRequestDetails(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data: request, error } = await supabase
        .from('recruiting_requests')
        .select('*')
        .eq('id', id)
        .single();

    if (error) {
        app.innerHTML = `<p>Error loading request details: ${error.message}</p>`;
        return;
    }

    let detailsHtml = `
        <h2>Request Details</h2>
        <div class="request-details">
            <p><strong>Position:</strong> ${request.position}</p>
            <p><strong>Department:</strong> ${request.department}</p>
            <p><strong>Headcount:</strong> ${request.headcount}</p>
            <p><strong>Description:</strong> ${request.description}</p>
            <p><strong>Position Type:</strong> ${request.position_type}</p>
            <p><strong>Position Category:</strong> ${request.position_category}</p>
            <p><strong>Status:</strong> ${request.status}</p>
            <p><strong>Confidential:</strong> ${request.is_confidential ? 'Yes' : 'No'}</p>
    `;

    if (request.position_type === 'new') {
        detailsHtml += `<p><strong>Reason for New Position:</strong> ${request.new_position_reason || 'Not provided'}</p>`;
    } else if (request.position_type === 'replacement') {
        detailsHtml += `<p><strong>Name of Person Being Replaced:</strong> ${request.replacement_name || 'Not provided'}</p>`;
    }

    detailsHtml += `
        </div>
        <div class="action-buttons">
    `;

    if (userRole === 'gm' && request.status === 'Pending') {
        detailsHtml += `
            <button onclick="approveRequest(${request.id})" class="btn btn-primary">Approve Request</button>
            <button onclick="rejectRequest(${request.id})" class="btn btn-danger">Reject Request</button>
        `;
    }

    if (request.status !== 'Filled') {
        detailsHtml += `<button onclick="fillPosition(${request.id})" class="btn btn-success">Position Filled</button>`;
    }

    detailsHtml += `
            <button onclick="showRequests()" class="btn btn-secondary">Back to Requests</button>
        </div>
    `;

    app.innerHTML = detailsHtml;
    applyTranslations(); // Apply translations after rendering content
}

async function showFilledPositions() {
    const supabase = getSupabase();
    if (!supabase) return;

    let query = supabase.from('recruiting_requests').select('*').eq('status', 'Filled');

    // Filter by department for non-GM users
    if (userRole !== 'gm') {
        query = query.eq('department', userDepartment);
    }

    const { data: filledPositions, error } = await query;

    if (error) {
        console.error('Error loading filled positions:', error);
        return;
    }

    let filledHtml = `
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Department</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    filledPositions.forEach(position => {
        filledHtml += `
            <tr>
                <td>${position.position}</td>
                <td>${position.department}</td>
                <td>${position.position_type}</td>
                <td>${position.position_category}</td>
                <td>
                    <button onclick="showRequestDetails(${position.id})">View Details</button>
                </td>
            </tr>
        `;
    });

    filledHtml += `
                </tbody>
            </table>
        </div>
    `;

    document.getElementById('filled-positions').innerHTML = filledHtml;
    applyTranslations(); // Apply translations after rendering content
}
function applyTranslations() {
    translatePage();
}

// Approve request
async function approveRequest(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data, error } = await supabase
        .from('recruiting_requests')
        .update({ status: 'Approved' })
        .eq('id', id);

    if (error) {
        alert('Error deleting request: ' + error.message);
    } else {
        alert('Request deleted successfully');
        showRequests();
    }
}
async function rejectRequest(id) {
    const supabase = getSupabase();
    if (!supabase) return;

    const { data, error } = await supabase
        .from('recruiting_requests')
        .update({ status: 'Rejected' })
        .eq('id', id);

    if (error) {
        alert('Error rejecting request: ' + error.message);
    } else {
        alert('Request rejected successfully!');
        showGMApproval();
    }
}

// Show GM Approval page
async function showGMApproval() {
    if (userRole !== 'gm') {
        app.innerHTML = '<p>Access denied. Only General Managers can view this page.</p>';
        return;
    }

    const supabase = getSupabase();
    if (!supabase) return;

    const { data: requests, error } = await supabase
        .from('recruiting_requests')
        .select('*')
        .eq('status', 'Pending');

    if (error) {
        app.innerHTML = `<p>Error loading pending requests: ${error.message}</p>`;
        return;
    }

    let requestsHtml = `
        <h2>Pending Recruiting Requests</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Department</th>
                        <th>Headcount</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Confidential</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    requests.forEach(request => {
        requestsHtml += `
            <tr>
                <td>${request.position}</td>
                <td>${request.department}</td>
                <td>${request.headcount}</td>
                <td>${request.position_type}</td>
                <td>${request.position_category}</td>
                <td>${request.is_confidential ? 'Yes' : 'No'}</td>
                <td>
                    <button onclick="showRequestDetails(${request.id})" class="btn btn-secondary">View Details</button>
                    <button onclick="approveRequest(${request.id})" class="btn btn-primary">Approve</button>
                    <button onclick="rejectRequest(${request.id})" class="btn btn-danger">Reject</button>
                </td>
            </tr>
        `;
    });

    requestsHtml += `
                </tbody>
            </table>
        </div>
    `;
    app.innerHTML = requestsHtml;
    applyTranslations(); // Apply translations after rendering content
}



// Language switcher
function switchLanguage(lang) {
    currentLanguage = lang;
    document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`${lang}-lang`).classList.add('active');
    translatePage();
}

function translatePage() {
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        element.textContent = translate(key);
    });
}

function translate(key) {
    if (!translations[currentLanguage]) {
        console.warn(`Translation for language "${currentLanguage}" not found.`);
        return key;
    }
    return translations[currentLanguage][key] || key;
}
// Update password modal
const modal = document.getElementById('update-password-modal');
const updatePasswordBtn = document.getElementById('update-password-btn');
const closeBtn = document.getElementsByClassName('close')[0];

updatePasswordBtn.onclick = function() {
    modal.style.display = 'block';
}

closeBtn.onclick = function() {
    modal.style.display = 'none';
}

window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// Handle password update
document.getElementById('update-password-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmNewPassword = document.getElementById('confirm-new-password').value;

    if (newPassword !== confirmNewPassword) {
        alert(translate('New passwords do not match'));
        return;
    }

    const supabase = getSupabase();
    try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError) throw userError;

        if (!user || !user.email) {
            throw new Error('Unable to get current user information');
        }

        // Verify current password
        const { error: signInError } = await supabase.auth.signInWithPassword({
            email: user.email,
            password: currentPassword
        });

        if (signInError) throw new Error('Current password is incorrect');

        // Update to new password
        const { error: updateError } = await supabase.auth.updateUser({
            password: newPassword
        });

        if (updateError) throw updateError;

        alert(translate('Password updated successfully'));
        modal.style.display = 'none';
    } catch (error) {
        console.error('Error updating password:', error);
        alert(translate('Error updating password. Please try again.'));
    }
});

let isDarkMode = false;

document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);

function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode', isDarkMode);
    localStorage.setItem('darkMode', isDarkMode);
    updateDarkModeButton();
}

function updateDarkModeButton() {
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    darkModeToggle.textContent = isDarkMode ? '☀️' : '🌙';
}

// Check user's preference when the page loads
document.addEventListener('DOMContentLoaded', () => {
    const savedDarkMode = localStorage.getItem('darkMode');
    if (savedDarkMode !== null) {
        isDarkMode = JSON.parse(savedDarkMode);
        document.body.classList.toggle('dark-mode', isDarkMode);
        updateDarkModeButton();
    }
});

async function showReports() {
    app.innerHTML = `
        <h2 data-translate="Advanced Reporting">Advanced Reporting</h2>
        <div class="report-options">
            <select id="report-type">
                <option value="candidates" data-translate="Candidates Report">Candidates Report</option>
                <option value="hiring" data-translate="Hiring Report">Hiring Report</option>
                <option value="source" data-translate="Source Report">Source Report</option>
            </select>
            <button onclick="generateReport()" class="btn btn-primary" data-translate="Generate Report">Generate Report</button>
        </div>
        <div id="report-container"></div>
    `;
    translatePage();
}

async function generateReport() {
    const reportType = document.getElementById('report-type').value;
    const supabase = getSupabase();
    if (!supabase) return;

    let reportData;
    switch (reportType) {
        case 'candidates':
            reportData = await generateCandidatesReport(supabase);
            break;
        case 'hiring':
            reportData = await generateHiringReport(supabase);
            break;
        case 'source':
            reportData = await generateSourceReport(supabase);
            break;
    }

    displayReport(reportData);
}

async function generateCandidatesReport(supabase) {
    const { data: candidates, error } = await supabase.from('candidates').select('*');
    if (error) {
        console.error('Error fetching candidates:', error);
        return [];
    }
    return candidates;
}

async function generateHiringReport(supabase) {
    const { data: candidates, error } = await supabase.from('candidates').select('*').eq('status', 'Hired');
    if (error) {
        console.error('Error fetching hired candidates:', error);
        return [];
    }
    return candidates;
}

async function generateSourceReport(supabase) {
    const { data: candidates, error } = await supabase.from('candidates').select('source, status');
    if (error) {
        console.error('Error fetching candidates:', error);
        return [];
    }
    const sourceCounts = candidates.reduce((acc, candidate) => {
        if (!acc[candidate.source]) {
            acc[candidate.source] = { total: 0, hired: 0 };
        }
        acc[candidate.source].total++;
        if (candidate.status === 'Hired') {
            acc[candidate.source].hired++;
        }
        return acc;
    }, {});
    return Object.entries(sourceCounts).map(([source, counts]) => ({
        source,
        total: counts.total,
        hired: counts.hired,
        effectiveness: (counts.hired / counts.total * 100).toFixed(2) + '%'
    }));
}

function displayReport(reportData) {
    const container = document.getElementById('report-container');
    const table = createTableFromData(reportData);
    container.innerHTML = '';
    container.appendChild(table);
    addExportButton(container, reportData);
}

function createTableFromData(data) {
    const table = document.createElement('table');
    const headers = Object.keys(data[0]);

    // Create header row
    const headerRow = table.insertRow();
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });

    // Create data rows
    data.forEach(row => {
        const dataRow = table.insertRow();
        headers.forEach(header => {
            const cell = dataRow.insertCell();
            cell.textContent = row[header];
        });
    });

    return table;
}

function addExportButton(container, data) {
    const exportButton = document.createElement('button');
    exportButton.textContent = translate('Export to CSV');
    exportButton.className = 'btn btn-secondary';
    exportButton.onclick = () => exportToCSV(data);
    container.appendChild(exportButton);
}

function exportToCSV(data) {
    const headers = Object.keys(data[0]);
    let csvContent = headers.join(',') + '\n';

    data.forEach(row => {
        const values = headers.map(header => {
            const value = row[header];
            return typeof value === 'string' ? `"${value}"` : value;
        });
        csvContent += values.join(',') + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'report.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

async function showStatistics() {
    console.log('showStatistics function called'); // For debugging

    const app = document.getElementById('app');
    app.innerHTML = '<h2 data-translate="Loading Statistics">Loading Statistics...</h2>';
    translatePage();

    try {
        // Use getSupabase() function if you have one, or directly use the supabase instance
        const supabase = getSupabase(); // or however you're accessing Supabase in other functions

        if (!supabase) {
            throw new Error('Supabase client is not available');
        }

        console.log('Fetching candidates...'); // For debugging
        const { data: candidates, error } = await supabase.from('candidates').select('*');

        if (error) {
            console.error('Supabase query error:', error); // For debugging
            throw error;
        }

        console.log('Candidates fetched:', candidates.length); // For debugging

        const stats = calculateStatistics(candidates);

        let statsHtml = '<h2 data-translate="Recruitment Statistics">Recruitment Statistics</h2>';
        statsHtml += '<table class="statistics-table">';
        for (const [key, value] of Object.entries(stats)) {
            statsHtml += `
                <tr>
                    <td data-translate="${key}">${key}</td>
                    <td>${value}</td>
                </tr>
            `;
        }
        statsHtml += '</table>';

        app.innerHTML = statsHtml;
        translatePage();
    } catch (error) {
        console.error('Error in showStatistics:', error);
        app.innerHTML = `<p data-translate="Error loading statistics">Error loading statistics: ${error.message}</p>`;
        translatePage();
    }
}

function calculateStatistics(candidates) {
    const stats = {
        'Total Candidates': candidates.length,
        'New Candidates': candidates.filter(c => c.status === 'New').length,
        'In Process - First Round': candidates.filter(c => c.status === 'In Process - First Round').length,
        'In Process - Second Round': candidates.filter(c => c.status === 'In Process - Second Round').length,
        'Hired Candidates': candidates.filter(c => c.status === 'Hired').length,
        'Rejected Candidates': candidates.filter(c => c.status === 'Rejected').length
    };

    // Calculate average time to hire
    const hiredCandidates = candidates.filter(c => c.status === 'Hired');
    if (hiredCandidates.length > 0) {
        const totalDays = hiredCandidates.reduce((sum, c) => {
            const start = new Date(c.date_obtained);
            const end = new Date(c.hire_date);
            return sum + (end - start) / (1000 * 60 * 60 * 24); // Convert to days
        }, 0);
        stats['Average Time to Hire'] = (totalDays / hiredCandidates.length).toFixed(1) + ' days';
    } else {
        stats['Average Time to Hire'] = 'N/A';
    }

    // Calculate source effectiveness
    const sourceCounts = candidates.reduce((acc, c) => {
        acc[c.source] = (acc[c.source] || 0) + 1;
        return acc;
    }, {});
    const topSource = Object.entries(sourceCounts).sort((a, b) => b[1] - a[1])[0];
    stats['Top Candidate Source'] = `${topSource[0]} (${topSource[1]} candidates)`;

    return stats;
}


document.addEventListener('DOMContentLoaded', function() {
    const statisticsButton = document.getElementById('nav-statistics');
    if (statisticsButton) {
        statisticsButton.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Statistics button clicked'); // For debugging
            showStatistics();
        });
    } else {
        console.error('Statistics button not found');
    }
});

async function checkExistingCandidate(name) {
    const supabase = getSupabase();
    if (!supabase) return false;

    const { data, error } = await supabase
        .from('candidates')
        .select('id, name')
        .ilike('name', name);

    if (error) {
        console.error('Error checking for existing candidate:', error);
        return false;
    }

    return data.length > 0 ? data : false;
}

// Initialize the app
document.addEventListener('DOMContentLoaded', async () => {
    await initSupabase();
    checkAuth();
    translatePage();
    document.getElementById('nav-reports').addEventListener('click', showReports);
    document.getElementById('nav-statistics').addEventListener('click', showStatistics);
});
